# Sonobuoy Calibration for SPL Estimation

## Overview

Sonobuoys record underwater sound using a hydrophone, but rather than directly storing the digital signals, they transmit them via radio telemetry. To accurately interpret the received audio and recover true sound pressure levels, we apply calibration constants to account for each stage of the system: hydrophone sensitivity, radio modulation, frequency-dependent system gain. 

This repository provides tools and documentation for calibrating received levels from CalCOFI Sonobuoy recordings. The goal is to compute **band-limited Sound Pressure Levels (SPL)** in **dB re 1 µPa** using FFT-based or `pwelch` methods. The provided example is specifically designed for bounding box-based detections generated by WhaleMoanDetector of low-frequency blue and fin whale calls.

## What This Repo Includes
- A MATLAB script to build a calibration struct (`Sonobuoy_calibration_specs.mat`) containing:
  - A/D voltage limits
  - Sonobuoy hydrophone sensitivity
  - ICOM radio modulation correction
  - Interpolated frequency response curves for 53D, 53G, and 57A sonobuoys
- An example SPL calibration script that:
  - Reads in bounding-box-based detections from WhaleMoanDetector
  - Extracts waveform segments
  - Computes band-limited power spectra
  - Applies full calibration
- Sample figures:
  - Frequency response curve JPEGs for each sonobuoy model
  - Histogram of calibrated SPLs for one call type

## Calibration Equations

### Step 1: Compute uncalibrated PSD (e.g., using `pwelch`)
$$
P_{xx}(f) = \text{Power spectrum in counts}^2/\text{Hz}
$$

### Step 2: Correct for system frequency response
$$
P_{xx,cal}(f) = 10^{\left(\log_{10}(P_{xx}(f)) - \frac{F(f)}{10}\right)}
$$
Where \( F(f) \) is the system frequency response curve in dB.

### Step 3: Integrate corrected power over the frequency band of interest
$$
P_{\text{band}} = \int_{f_1}^{f_2} P_{xx,cal}(f) \, df
$$

### Step 4: Convert to dB and apply calibration constants
$$
\text{SPL} = 10 \log_{10}(P_{\text{band}}) + V + S + \text{ICOM}
$$

Where:
- \( V = 20 \log_{10}(\text{ADC volts} / \text{bit resolution}) \)
- \( S = \text{Sonobuoy sensitivity (dB re 1 V/µPa)} \)
- \( \text{ICOM} = \text{Radio demodulation gain (dB)} \)

## Example Workflow

1. Load detection timestamps and corresponding WAV file.
2. Use `audioread()` to extract the time segment.
3. Compute power spectrum using `pwelch()` with 90% overlap and Hamming window.
4. Correct the spectrum using the frequency response curve.
5. Integrate and calibrate the band-limited power.
6. Store the final SPL in dB re 1 µPa.

```matlab
[Pxx, F] = pwelch(signal_segment, hamming(fs), round(0.9*fs), fs, fs);
Pxx_corr = Pxx(freq_mask) ./ 10.^(F_dB(freq_mask) / 10);
P_lin = trapz(F(freq_mask), Pxx_corr);
X_dB = 10*log10(P_lin);
SPL = X_dB + V + S + ICOM;
